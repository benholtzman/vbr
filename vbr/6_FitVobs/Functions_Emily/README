USING THE VBR TO INVERT FOR STATE VARIABLES FROM SEISMIC DATA



**********************   1. Initial run of the VBR   ***********************
The first step in running the VBR is calculating a suite of 'Boxes' - each Box is  associated with an input value, e.g. potential temperature, plate thickness.  The values for these inputs are set in generate_boxes as
   settings.Box.var1range  - vector of values
   settings.Box.var1name   - must match a field in the settings structure*
   settings.Box.var1units  - string with units for .var1var1range

   Can set similar fields for var2range/name/units if want 2D Box suite

* settings initiated in vbr/2_PLATES/4pt0_1d_plates/00_init_conds/init_settings
  Field names include      'Tpot'        Potential temperature (C)
                           'grain0'      Grain size (m)
                           'Z_moho_km'   Moho depth (km)
                           'zPlate'      Plate thickness (km)
    There are many others, e.g. olivine conductivity, water concentration etc
    Also phi_min, although melt will actually be added in a later stage

For the first run, var1name should be 'Tpot' and var2name should be 'zPlate'.

For each box, Box(i_var1, i_var2), this will calculate an equilibrium geotherm for the input settings as well as various other parameters.
Box(i_var1,i_var2).Frames(end)  has the following fields of n_dep x 1 vectors:
Vbgz (), phi (melt fraction), Eta (viscosity), P (pressure), T (temperature), cp (heat capacity), rho (density), Kc (thermal conductivity), dg_um (grain size in micrometres), sig_MPa (), Tsol (), Cs_H2O (water concentration in solid, ppm), Cs_CO2 (CO2 concentration in solid, ppm), Cf_H2O (water concentration in fluid, ppm), Cf_CO2 (CO2 concentration in fluid, ppm), comp (proportion of mantle to crustal materials for the purposes of calculating e.g. mean conductivity, ranging from 0-1).

Calculating the boxes is the most time consuming part of the process, so you should aim to run this once with a large range of values (or download a previously calculated set of boxes if those fit your needs).


Once the boxes have been calculated, the VBR is run.  This calculates seismic and viscous properties for the conditions for each of the suite of Boxes.  At this stage, we are really trying to nail down zPlate - which doesn't have as large trade-offs with the other parameters.  The parameters of these calculations are in run_vbr, but they probably don't need to be changed.  Output saved in Box(i_var1,i_var2).Frames(end).VBR.



****************   2. Importing shear velocity data   *********************

All velocity models should be saved in Functions_Emily/vel_models
Following format required:
    - filename:  [MODEL REGION]_[REFERENCE]    e.g. USA_ShenRitzwoller2016
        Note: Do not include underscores in name of model region or citation
              Region name for all models in same region should be identical
    - variable name: Vs_Model
    - variable should be a structure with the following fields
        - Name:       optional, e.g. string of reference info
        - Latitude:   n_lat x 1 vector of latitude points
        - Longitude:  n_lon x 1 vector of longitude points
        - Depth:      n_dep x 1 vector of depth points
        - Vs:         n_lat x n_lon x n_dep matrix of Vs values
        - Error:      n_lat x n_lon x n_dep matrix of uncertainty on Vs


All LAB data should be saved in Functions_Emily/LAB_models
Following format required:
    - filename:  [MODEL REGION]_[REFERENCE]    e.g. USA_HopperFischer2018
    - variable name: LAB_Model
    - variable should be a structure with the following fields
        - Name:       optional, e.g. string of reference info
        - Latitude:   n_lat x 1 vector of latitude points
        - Longitude:  n_lon x 1 vector of longitude points
        - LAB_Depth:  n_lat x n_lon matrix of depths
        - Error:      n_lat x n_lon matrix of uncertainty on LAB_Depth

In all cases, longitudes above 180E should be written as negative.

All model choices will be made via user input to the command line.
Alternatively, can hardwire in which models & location to use:
  - vel_models/use_this_model.mat: string of file name e.g. USA_ShenRitzwoller2016
  - lab_models/use_this_model.mat: string of file name e.g. USA_HopperFischer2018
  - vel_models/use_this_location.mat: vector [latitude, longitude]
  - vel_models/use_this_depthrange.mat: vector [min_depth, max_depth]*
Note: if any of these files exist, will automatically try to use that model, so need to delete the file if no longer want to hardwire in that choice.

* This is the depth range in which the VBR will try to match observed asthenospheric shear velocities.



****************   3. Fitting plate thickness   *********************

Plate thickness is estimated based on calculated attenuation at a variety of conditions.  The boxes in (1) calculate, among other things, the Q expected for a variety of pairs of conditions (typically Box(potential temperature, plate thickness)).  This is a grid search, running through all possible sets of conditions and finding the Q profile for the frequency band of interest.

It is assumed that the seismic LAB corresponds to some drop off in seismic attenuation with depth.  This depth, Z_LAB_Qs_km, is the LAB depth as defined by the Q structure (specifically, where quality factor drops below some value; equivalently, where attenuation rises above some value).  Note that the observed seismic LAB (based on changes in shear velocity) should be at the same depth as the Q defined LAB; in general, this will be SHALLOWER than the zPlate.  So the grid search runs through all values of zPlate, calculates the Q defined LAB depth based on the calculated Q profiles, and finds the zPlate that gives the Q defined LAB closest to the seismically observed LAB.

If the variable dont_use_input_Qlab is set to 1 (currently hardwired in fit_LAB_Tp), the conditions will be determined by finding the best match between the input (seismically observed) LAB and the depth range at which seismic attenuation is at some factor above the mean adiabatic Q.  With the currently hardwired values, this is the depth at which the high Q lithosphere transitions to less than 20 x (fQlab, set in find_LAB_Q_Res) the mean adiabatic Q (mean Q below zPlate, as set by the Box index).

If the variable dont_use_input_Qlab is set to 0 (currently hardwired as not), the depth will instead be identified as where Q drops below a hardwired value (Q_LAB, set in fit_LAB_Tp - set to 800).

Note that it does actually do a joint inversion for Tp and zPlate in this case.  This allows you to see if the observations can be well fit by just varying Tp and zPlate.  However, if there is melt present, the Tp estimates will be very inaccurate, so a multivariate analysis (the next step) is required.  Even in this case, zPlate is most strongly dependent on the seismically observed LAB - so the best fit value of zPlate should be ok.
